import streamlit as st
import pandas as pd
import io
from typing import Dict, Tuple
import random
import os

st.set_page_config(page_title="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏–π", layout="wide")

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É promt –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
PROMT_FILE_PATH = os.path.join(os.path.dirname(__file__), 'promt')

def parse_prompt_file(content: str) -> Dict[str, str]:
    """–ü–∞—Ä—Å–∏—Ç —Ñ–∞–π–ª promt –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è."""
    prompts = {}
    lines = content.split('\n')

    current_type = None
    current_prompt = []

    i = 0
    while i < len(lines):
        line = lines[i].strip()

        # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —Ç–∏–ø–∞–º–∏ –∑–∞–¥–∞–Ω–∏–π (–∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –Ω–∞ —Ç–∞–±—É–ª—è—Ü–∏—é –∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å "–ó–∞–¥–∞–Ω–∏—è")
        if '\t' in lines[i] and line.startswith('–ó–∞–¥–∞–Ω–∏—è'):
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ–º–ø—Ç
            if current_type and current_prompt:
                prompts[current_type] = '\n'.join(current_prompt)

            # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ —Ç–∞–±—É–ª—è—Ü–∏–∏
            parts = lines[i].split('\t')
            if len(parts) >= 2:
                current_type = parts[0].strip()
                current_prompt = [parts[1].strip()]
            i += 1
        elif current_type:
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –∫ —Ç–µ–∫—É—â–µ–º—É –ø—Ä–æ–º–ø—Ç—É
            if line and not line.startswith('‚Üí'):
                current_prompt.append(line)
            i += 1
        else:
            i += 1

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–º–ø—Ç
    if current_type and current_prompt:
        prompts[current_type] = '\n'.join(current_prompt)

    return prompts


def generate_matching_task(competence: str, indicator: str, discipline: str) -> Tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è."""

    task = f"""–°–æ–æ—Ç–Ω–µ—Å–∏—Ç–µ –ø–æ–Ω—è—Ç–∏—è, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ —Ä–∞–º–∫–∞—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞: {indicator}

–≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:
1. –ü–æ–Ω—è—Ç–∏–µ 1
2. –ü–æ–Ω—è—Ç–∏–µ 2
3. –ü–æ–Ω—è—Ç–∏–µ 3
4. –ü–æ–Ω—è—Ç–∏–µ 4

–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
–ê. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–Ω—è—Ç–∏—è 1
–ë. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–Ω—è—Ç–∏—è 2
–í. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–Ω—è—Ç–∏—è 3
–ì. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–Ω—è—Ç–∏—è 4"""

    key = "1–ê, 2–ë, 3–í, 4–ì"
    return task, key


def generate_sequence_task(competence: str, indicator: str, discipline: str) -> Tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏."""

    task = f"""–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ç–∞–ø–æ–≤, –¥–µ–π—Å—Ç–≤–∏–π –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞: {indicator}

1. –≠—Ç–∞–ø –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
2. –≠—Ç–∞–ø –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
3. –≠—Ç–∞–ø —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
4. –≠—Ç–∞–ø –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –æ—Ü–µ–Ω–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""

    key = "1, 2, 3, 4"
    return task, key


def generate_single_choice_task(competence: str, indicator: str, discipline: str) -> Tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –æ–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º."""

    task = f"""–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–∏–±–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ —Å—É—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ "{indicator}" –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}", –∏ –æ–±—ä—è—Å–Ω–∏—Ç–µ —Å–≤–æ–π –≤—ã–±–æ—Ä:

1. –í–∞—Ä–∏–∞–Ω—Ç, —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π —Å—É—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
2. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É
3. –í–∞—Ä–∏–∞–Ω—Ç, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã
4. –í–∞—Ä–∏–∞–Ω—Ç —Å —á–∞—Å—Ç–∏—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å—é"""

    key = "3. –û–±—ä—è—Å–Ω–µ–Ω–∏–µ: –î–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É, —Ç–∞–∫ –∫–∞–∫ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏ –æ—Ç—Ä–∞–∂–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º–æ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏."
    return task, key


def generate_multiple_choice_task(competence: str, indicator: str, discipline: str) -> Tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º."""

    task = f"""–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "{indicator}" –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}", –∏ –ø–æ—è—Å–Ω–∏—Ç–µ –≤–∞—à –≤—ã–±–æ—Ä:

1. –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ –æ–¥–∏–Ω –∏–∑ –∞—Å–ø–µ–∫—Ç–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
2. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–µ–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É
3. –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ –¥—Ä—É–≥–æ–π –∞—Å–ø–µ–∫—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
4. –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –Ω–µ–ø–æ–ª–Ω–æ–π –∏–ª–∏ –∏—Å–∫–∞–∂–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"""

    key = "1, 3. –û–±—ä—è—Å–Ω–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç—ã 1 –∏ 3 –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ —Ä–∞–º–∫–∞—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã. –í–∞—Ä–∏–∞–Ω—Ç 1 –æ–ø–∏—Å—ã–≤–∞–µ—Ç [–ø–µ—Ä–≤—ã–π –∞—Å–ø–µ–∫—Ç], –∞ –≤–∞—Ä–∏–∞–Ω—Ç 3 —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç [–≤—Ç–æ—Ä–æ–π –∞—Å–ø–µ–∫—Ç], —á—Ç–æ –≤ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞."
    return task, key


def generate_open_task(competence: str, indicator: str, discipline: str) -> Tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ç–∏–ø–∞."""

    task = f"""–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "{indicator}" –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}".

–í —Å–≤–æ–µ–º –æ—Ç–≤–µ—Ç–µ:
- –†–∞—Å–∫—Ä–æ–π—Ç–µ —Å—É—â–Ω–æ—Å—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ –¥–∞–Ω–Ω–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ
- –ü—Ä–∏–≤–µ–¥–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Å–∏—Ç—É–∞—Ü–∏–π –∏–ª–∏ –∑–∞–¥–∞—á, –≥–¥–µ —ç—Ç–æ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è
- –û–±—ä—è—Å–Ω–∏—Ç–µ, –∫–∞–∫–∏–µ –∑–Ω–∞–Ω–∏—è, —É–º–µ–Ω–∏—è –∏–ª–∏ –Ω–∞–≤—ã–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞"""

    key = f"""–í–æ–∑–º–æ–∂–Ω–∞—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è:

–í —Ä–∞–º–∫–∞—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã "{discipline}" –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

1. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç: —Å—Ç—É–¥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã.

2. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç: –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞–Ω–∏–π –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö –¥–ª—è –¥–∞–Ω–Ω–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã.

3. –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞:
   - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
   - –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—à–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑—É—á–µ–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
   - –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–æ–≤ –∏ –ø–æ–¥—Ö–æ–¥–æ–≤

4. –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏: –∑–Ω–∞–Ω–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–π –±–∞–∑—ã –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã, —É–º–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∑–Ω–∞–Ω–∏—è –≤ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –Ω–∞–≤—ã–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è."""
    return task, key


def generate_task(prompt_template: str,
                  competence: str,
                  indicator: str,
                  discipline: str,
                  task_type: str) -> Tuple[str, str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞–Ω–∏–µ –∏ –∫–ª—é—á –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–æ–≤."""

    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è –∏ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
        if "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏" in task_type.lower():
            return generate_matching_task(competence, indicator, discipline)
        elif "–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç" in task_type.lower():
            return generate_sequence_task(competence, indicator, discipline)
        elif "–æ–¥–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ" in task_type.lower():
            return generate_single_choice_task(competence, indicator, discipline)
        elif "–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö" in task_type.lower():
            return generate_multiple_choice_task(competence, indicator, discipline)
        elif "–æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ç–∏–ø–∞" in task_type.lower():
            return generate_open_task(competence, indicator, discipline)
        else:
            # –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–∫—Ä—ã—Ç–æ–µ –∑–∞–¥–∞–Ω–∏–µ
            return generate_open_task(competence, indicator, discipline)

    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {str(e)}", f"–û—à–∏–±–∫–∞: {str(e)}"


def main():
    st.title("üéì –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É—á–µ–±–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π")
    st.markdown("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–æ–≤")
    st.markdown("---")

    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    with st.sidebar:
        st.header("üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è")
        st.markdown("""
        1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª megaphops.xlsx
        2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        3. –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è"
        4. –°–∫–∞—á–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        """)

        st.markdown("---")
        st.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI API")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª promt –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    prompts = {}
    if os.path.exists(PROMT_FILE_PATH):
        try:
            with open(PROMT_FILE_PATH, 'r', encoding='utf-8') as f:
                prompt_content = f.read()
                prompts = parse_prompt_file(prompt_content)
            st.success(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(prompts)} —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π –∏–∑ —Ñ–∞–π–ª–∞ promt")
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ promt: {str(e)}")
    else:
        st.warning(f"‚ö†Ô∏è –§–∞–π–ª promt –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {PROMT_FILE_PATH}")

    # –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å
    st.subheader("üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏")
    excel_file = st.file_uploader(
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª megaphops.xlsx",
        type=['xlsx', 'xls'],
        help="–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã: A-–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è, B-–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä, C-–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, D-–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è, E-–ó–∞–¥–∞–Ω–∏–µ, F-–ö–ª—é—á"
    )

    if excel_file:
        # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
        df = pd.read_excel(excel_file)

        st.success(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df)} —Å—Ç—Ä–æ–∫ –∏–∑ Excel —Ñ–∞–π–ª–∞")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö
        with st.expander("üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)"):
            st.dataframe(df.head())

        st.markdown("---")

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        st.subheader("‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")

        col3, col4 = st.columns(2)
        with col3:
            start_row = st.number_input("–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞", min_value=0, max_value=len(df)-1, value=0)
        with col4:
            end_row = st.number_input("–ö–æ–Ω–µ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞", min_value=start_row+1, max_value=len(df), value=min(start_row+10, len(df)))

        batch_size = end_row - start_row
        st.info(f"üìä –ë—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: {batch_size}")

        # –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if st.button("üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è", type="primary", use_container_width=True):
            # –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
            progress_bar = st.progress(0)
            status_text = st.empty()

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫
            for idx in range(start_row, end_row):
                row = df.iloc[idx]

                # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏
                competence = str(row.iloc[0])
                indicator = str(row.iloc[1])
                discipline = str(row.iloc[2])
                task_type = str(row.iloc[3])

                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å NaN –≤ —Ç–∏–ø–µ –∑–∞–¥–∞–Ω–∏—è
                if pd.isna(row.iloc[3]) or task_type == 'nan':
                    status_text.warning(f"‚è≠Ô∏è –°—Ç—Ä–æ–∫–∞ {idx+1}: –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–Ω–µ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è)")
                    continue

                status_text.info(f"üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ {idx+1}/{end_row}...")

                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–æ–≤
                prompt_template = prompts.get(task_type, "")
                task, key = generate_task(
                    prompt_template,
                    competence,
                    indicator,
                    discipline,
                    task_type
                )

                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                df.at[idx, df.columns[4]] = task  # –°—Ç–æ–ª–±–µ—Ü E (–ó–∞–¥–∞–Ω–∏–µ)
                df.at[idx, df.columns[5]] = key   # –°—Ç–æ–ª–±–µ—Ü F (–ö–ª—é—á)

                status_text.success(f"‚úÖ –°—Ç—Ä–æ–∫–∞ {idx+1} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞")

                # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                progress = (idx - start_row + 1) / batch_size
                progress_bar.progress(progress)

            progress_bar.progress(1.0)
            status_text.success("üéâ –í—Å–µ –∑–∞–¥–∞–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!")

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            st.markdown("---")
            st.subheader("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã")
            st.dataframe(df.iloc[start_row:end_row])

            # –≠–∫—Å–ø–æ—Ä—Ç
            st.markdown("---")
            st.subheader("üíæ –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")

            # –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç–∏
            output = io.BytesIO()
            with pd.ExcelWriter(output, engine='openpyxl') as writer:
                df.to_excel(writer, index=False, sheet_name='–ó–∞–¥–∞–Ω–∏—è')

            excel_data = output.getvalue()

            st.download_button(
                label="üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (Excel)",
                data=excel_data,
                file_name="result_with_tasks.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                use_container_width=True
            )

    else:
        st.info("üëÜ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª megaphops.xlsx –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã")


if __name__ == "__main__":
    main()
